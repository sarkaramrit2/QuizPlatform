var labelUrl = "";

function getManualPOGData(labelUrl) {
	var comingSoon = $("#coming-soon").is(":checked");
	var ajaxUrl = '/admin/productElevationSearchMLN/getTrebuchetProductsByLabel?labelUrl=' + labelUrl + '&isComingSoon=' + comingSoon;
	$.ajax({url:ajaxUrl, type: "GET", dataType: 'json', success: function(data) {
		updateManualPOGData(data);
	}});
}

function updateManualPOGData(data) {
	var tablehtml = "";
	if(data != undefined && data != '') {
		for(var i = 0 ; i < data.length; i++) {
			if(i == 0) {
				tablehtml = tablehtml+'<table class="table table-striped" id="errorPogsTable"><thead><tr>' + 
				'<th>S. No.</th><th>PogId</th><th>Name</th><th>Page URL</th></tr></thead>';
			}
			var j = i+1;
			tablehtml = tablehtml + '<tr><td>' + j + '</td><td>' + data[i].pog + '</td><td>' + data[i].productName +
			'</td><td><a href="' + contextPath + data[i].pageUrl  +'">Link</a></td></tr>';
		
			if(i == data.length - 1) {
				tablehtml = tablehtml + '</table>';
			}
		}
	}
	$("#manualProductsData").html(tablehtml);
}

$("#uploadButton").click(function() {
	if(labelUrl == "") {
		addError("Please select a label Url");
		$('#upload').modal('hide');
		return true;
	}
	var comingSoon = $("#coming-soon").is(":checked");
	var url = $("#uploadForm").attr("action") + '?labelUrl=' + labelUrl + '&isComingSoon=' + comingSoon;
	
	$("#uploadForm").attr("action", url);
	$("#uploadForm").submit();
	$("#modelHeaderId").hide();
	$("#modelId").hide();
	$("#modelFooterId").hide();
	$("#loaderDiv").show();
});


window.onload=function() {
	if(tab != '') {
		$(tab).removeClass("disableTag");
		$(tab).tab('show');
	}
}

var engine = new Bloodhound({
	  name: 'labels',
	  local: labels,
	  limit: 1000,
	    datumTokenizer: function(d) { 
	    	return d.url.split("-").concat(d.displayName.split(" ")).concat(d.nodePath.split("-")); },
	    queryTokenizer: Bloodhound.tokenizers.whitespace
	    
});	

engine.initialize();

$('#label-search').typeahead({
	hint: true,
	highlight: true,
	minLength: 1
	},
	{
	name: 'engine',
	displayKey: 'nodePath',
	source: engine.ttAdapter(),
	 templates: {
		 suggestion: Handlebars.compile('<p>{{displayName}} â€“ ({{nodePath}})</p>')
	 }
});


$('#label-search').on('typeahead:autocompleted', function (object, datum) {
	addLabel(datum);
});

$('#label-search').on('typeahead:selected', function (object, datum) {
	addLabel(datum);
});


function addLabel(label) {
	if($("#selectedLabel").html() == undefined || $("#selectedLabel").html() == "") {
		labelUrl = label.nodePath;
		$('#selectedLabel').append('<div id="label-' + labelUrl + '" labelUrl="' + labelUrl + '" class="form-group labelSelect"><h3><span class="label label-primary">' + label.displayName + 
				'</span><br/><br/><span class="label label-primary">('
				+ label.nodePath +')</span><button type="button" class="close" aria-hidden="true" onclick=removeLabel("' + labelUrl + '")>&times;</button></h3></div>');
		updateData();
	}
}

function removeLabel(labelUrl) {
	$('#selectedLabel').html("");
	$('#manualProductsData').html("");
	labelUrl = "";
}


function updateData() {
		if(	labelUrl != "") {
			$("#trebuchetModal").show();
			getManualPOGData(labelUrl);
		} else {
			$("#trebuchetModal").hide();
		}
}

$("#coming-soon").change(function() {
	updateData();
})