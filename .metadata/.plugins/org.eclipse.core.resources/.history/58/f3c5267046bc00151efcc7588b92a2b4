var campaignId = '';
$("#load-more").hide();


$('#startDate').datetimepicker({
	pickDate: true,              
    pickTime: true
});
$('#endDate').datetimepicker({
	pickDate: true,                 
    pickTime: true
});
$("#startDate").focusout(function() {
	$("#startDate").data("DateTimePicker").hide();
});
$("#endDate").focusout(function() {
	$("#endDate").data("DateTimePicker").hide();
});

$("#campaignName").focusout(function() {
	generateCampaignUrl();
});

$('#campaign-search').typeahead([
  {
	    valueKey: 'name',
	    local: campaigns,
	    template: [                                                                 
	   	        '<p class="name">{{name}}</p>',
	   	].join(''),
	   	highlight: true,
	   	limit: typeaheadLimit,
	    engine: Hogan
  }
]);

$('#campaign-search').on('typeahead:autocompleted', function (object, datum) {
	getCampaign(datum);
});

$('#campaign-search').on('typeahead:selected', function (object, datum) {
	getCampaign(datum);
});

 function submitCampaign() {
	 var campaignName = $("#campaignName").val();
	 var startDate = $("#startDate").val();
	 var endDate = $("#endDate").val();
	 var enabled = $("#enabled").is(":checked");
	 var sortBy = $('#sortBy option:selected').attr("type");
	 var campaignUrl = $("#campaignUrl").val();
	 var ajaxUrl = '/admin/landingPage/submitCampaign?campaignName=' + encodeURIComponent(campaignName) + '&startDate=' + encodeURIComponent(startDate) + 
	 				'&endDate=' + encodeURIComponent(endDate) + '&enabled=' + enabled +
	 				'&sortBy=' + sortBy + '&campaignId=' + campaignId + '&campaignUrl=' + campaignUrl;
	 $.ajax({
			url : ajaxUrl,
			dataType : 'json',
			success : function(data) {
				var status = data['status'];
				var msg = data['message'];
				if (status == "success") {
					resetAll();
					addSuccessMessage(msg);
				} else {
					addError(msg);
				}
			}
	});
 }
 
function getPOGData(start, rows) {
	var sortBy = $('#sortBy option:selected').attr("type");
	var ajaxUrl = '/admin/landingPage/getCampaignProductsForCampaign?campaignId=' + campaignId + '&start=' + start + '&rows=' + rows 
				+ '&sortBy=' + sortBy;
	$.ajax({url:ajaxUrl, type: "GET", dataType: 'json', success: function(data) {
		setCampaignPogs(data, start, rows);
	}});
}

function getCampaign(campaign) {
	resetAll();
	campaignId = campaign.id;
	
	var ajaxUrl = '/admin/landingPage/getCampaignDTOById?campaignId=' + campaignId;
	$.ajax({url:ajaxUrl, type: "GET", dataType: 'json', success: function(data) {
		updateCampaignData(data);
		$("#addEditCampaign").tab('show');
	}});
}

function getManualPOGData(campaignId, updateType) {
	
	var ajaxUrl = '/admin/landingPage/getManualCampaignProductsByIdAndType?campaignId=' + campaignId + '&updateType=' + updateType;
	$.ajax({url:ajaxUrl, type: "GET", dataType: 'json', success: function(data) {
		updateManualPOGData(data);
	}});
}

function updateManualPOGData(data) {
	var tablehtml = "";
	if(data != undefined && data != '') {
		for(var i = 0 ; i < data.length; i++) {
			if(i == 0) {
				tablehtml = tablehtml+'<table class="table table-striped" id="errorPogsTable"><thead><tr>' + 
				'<th>S. No.</th><th>PogId</th><th>name</th><th>Priority</th><th>categoryUrl</th><th>Url</th></tr></thead>';
			}
			var j = i+1;
			tablehtml = tablehtml + '<tr><td>' + j + '</td><td>' + data[i].id + '</td><td>' + data[i].name +
			'</td><td>' + data[i].priority + '</td><td>'  + data[i].categoryUrl 
			+ '</td><td><a href="' + contextPath + "/" + data[i].url  +'">Link</a></td></tr>';
		
			if(i == data.length - 1) {
				tablehtml = tablehtml + '</table';
			}
		}
	}
	$("#manualProductsData").html(tablehtml);
}

function updateCampaignData(campaign) {
	$("#campaignName").val(campaign.name);
	$("#campaignUrl").val(campaign.url);
	$("#customCampaignName").html(campaign.name);
	$("#customCampaignNameGroup").show();
	$("#startDate").val(campaign.startDate);
	$("#endDate").val(campaign.endDate);
	$("#manualPOGs").attr("data-toggle", "tab");
	$("#manualPOGs").removeClass("disableTab");
	$("#updateTypeSelect").show();
	console.log(campaign.enabled);
	if(campaign.enabled) {
		$("#enabled").prop('checked', true);;
	}
	if(campaign.addProducts) {
		$("#addProducts").prop('checked', true);;
	}
	if(campaign.removeProducts) {
		$("#removeProducts").prop('checked', true);;
	}
	$('#sortBy option').each(function() { 
		if($(this).attr("type") == campaign.sortBy) { 
			$("#sortBy").val($(this).val());
		}
	});
	getPOGData(0, rowSize);
}

function resetAll() {
	campaignId = "";
	$("#enabled").removeAttr("checked");
	$("#addProducts").removeAttr("checked");
	$("#removeProducts").removeAttr("checked");
	$("#startDate").val("");
	removeValidation($("#startDate"));
	$("#endDate").val("");
	removeValidation($("#endDate"));
	$("#sortBy").val("");
	$("#products").html("");
	$("#campaignName").val("");
	$("#customCampaignName").html("");
	$("#customCampaignNameGroup").hide();
	$("#updateTypeSelect").hide();
	$("#campaignUrl").val("");
	removeValidation($("#campaignName"));
	removeValidation($("#campaignUrl"));

	$("#load-more").hide();
	$("#campaignCustom").hide();
	$("#message").html("");
	//Disabling tabs
	$("#manualPOGs").addClass("disableTab");
	$("#manualPOGs").attr("data-toggle", "");

	$("#pogErrors").addClass("disableTab");
	$("#pogErrors").attr("data-toggle", "");
	$("#paginationTab").html("");
	$('#updateType').val("");
}

function generateCampaignUrl() {
	var name = $("#campaignName").val();
	for (i = 0; i < name.length; i++) {
		name = name.replace(/[_\W]+/g, " ").replace(/\s+/g, "-");
	}
	name = name.toLowerCase();
	$("#campaignUrl").val(name);
}

//For uploading file
$("#uploadButton").click(function() {
	var updateType =  $('#updateType option:selected').attr("type");
	var url = $("#uploadForm").attr("action") + "?campaignId=" + campaignId + "&updateType=" + updateType;
	$("#uploadForm").attr("action", url);
	$("#uploadForm").submit();
	$("#modelHeaderId").hide();
	$("#modelId").hide();
	$("#modelFooterId").hide();
	$("#loaderDiv").show();
});

$("#updateType").change(function() {
	var updateType =  $('#updateType option:selected').attr("type");
	if(	$(this).val() != "") {
		$("#campaignCustom").show();
		getManualPOGData(campaignId, updateType);
	}
});

$('#sortBy').change(function() {
	if(	$(this).val() != "") {
		getPOGData(0, rowSize);
	}
});

$('#startDate').keydown(function(e) {
   e.preventDefault();
   return false;
});

$('#endDate').keydown(function(e) {
	   e.preventDefault();
	   return false;
});

window.onload=function() {
	if(tab != '') {
		$(tab).removeClass("disableTag");
		$(tab).tab('show');
	}
}
