var selectedBrandId = '';
var selectedSubcatId = '';
var selectedCatId = '';

$('#brand-search').typeahead([
                 {
               	    valueKey: 'name',
               	    local: allBrands,
               	    template: [                                                                 
               	   	        '<p class="name">{{name}}</p>',
               	   	].join(''),
               	   	highlight: true,
               	   	limit: typeaheadLimit,
               	    engine: Hogan
                 }
               ]);

$('#brand-search').on('typeahead:autocompleted', function (object, datum) {
	viewAllSubCategoryIdsByBrandId(datum);
});

$('#brand-search').on('typeahead:selected', function (object, datum) {
	viewAllSubCategoryIdsByBrandId(datum);
});

$('#subcat-search').typeahead([
                  {
                	    valueKey: 'displayName',
                	    local: allLeafLabels,
                	    template: [
                	   	        '<p class="name">{{displayName}} - ({{url}})</p>',
                	   	].join(''),
                	   	highlight: true,
                	   	limit: typeaheadLimit,
                	    engine: Hogan
                  }
                ]);

 $('#subcat-search').on('typeahead:autocompleted', function (object, datum) {
	 viewAllBrandsBySubcatId(datum);
 });

 $('#subcat-search').on('typeahead:selected', function (object, datum) {
	 viewAllBrandsBySubcatId(datum);
 });

function viewAllSubCategoryIdsByBrandId(datum) {
	var id = '';
	var type = 'BRAND';
	var entityName = datum.name;
	if (entityName == '') {
		addError('Please Select a valid brand:');
		return false;
	}
	var ajaxUrl = "/admin/rbf/getTop?entityId=" + id + "&type=" + type + "&entityName=" + escape(entityName);
	$.ajax({
			url : ajaxUrl,
			type : "POST",
			dataType : 'json',
			success : function(data) {
				if(data.status == 'success') {					
					var subcats = data.items.topEntitySRO.allEntities;
					html = '<option value="0">Please select Sub Category</option>';
					for ( var i = 0; i < subcats.length; i++) {
						html += "<option value='" + subcats[i].id + "'>" + subcats[i].name
						+ "</option>";
					}
					$('#view-bw-subcategory').html(html);
					var brandName = $('#brand-search').val();
					var tableContent = data.items.topEntitySRO.topMatchingEntityList;
					populateBrandWidgetTable(brandName, tableContent);
				} else {
					addError("Failed to load sub categories for Brand.");
				}
			}
		});
}

function populateBrandWidgetTable(brandName, tableContent) {
	$('#bw-topSubcatsTable').dataTable().fnClearTable();
	
	if (tableContent != null && tableContent.length > 0) {
		for ( var i = 0; i < (tableContent.length); i++) {
			$('#bw-topSubcatsTable')
				.dataTable()
				.fnAddData(
					[	(i + 1),
					 	brandName,
						tableContent[i].name,
						tableContent[i].properties.priority
					]);
		}
	}
}

$("#update-brand-priority-button").click(function() {
	var brandName = $('#brand-search').val();
	var subcatId = $('#view-bw-subcategory option:selected').attr('value');
	var priority = $('#brandPriorityId').val();

	if (brandName == "0"  || brandName == '') {
		addError("Please select a valid brand");
		return false;
	}
	if (subcatId == "0") {
		addError("Please select a valid subcategory");
		return false;
	}
	if( priority == null || priority == "") {
		addError("Please add priority");
		return false;
	}
	updateBrandWidgetPriority(brandName, subcatId, priority);	
});


function updateBrandWidgetPriority(brandId, subcatId, priority) {
	var entityName = $('#brand-search').val();
	var type = 'BRAND';
	var depType = 'LEAF_CATEGORY'; 
	var ajaxUrl = "/admin/rbf/update?entityId=" + brandId + "&entityName=" + escape(entityName) + "&matchingEntityId=" + subcatId + "&priority=" + priority 
					+ "&type=" + type + "&depType=" + depType;
	$.ajax({
			url : ajaxUrl,
			type : "POST",
			dataType : 'json',
			success : function(data) {
				if(data.status == 'success') {
					var brandName = $('#brand-search').val();
					var tableContent = data.items.topEntitySRO.topMatchingEntityList;
					populateBrandWidgetTable(brandName, tableContent);
					
					addSuccessMessage(data.message);
				} else {
					addError(data.message);
				}
			}
		});
}


function viewAllBrandsBySubcatId(datum) {
	//var id = datum.id;
	selectedSubcatId = datum.url;
	var type = 'LEAF_CATEGORY';
	var entityName = datum.displayName;
	if (entityName == '') {
		addError('Please Select a valid category.');
		return false;
	}
	var ajaxUrl = "/admin/rbf/getTop?entityId=" + selectedSubcatId + "&type=" + type + "&entityName=" + escape(entityName);
	$.ajax({
			url : ajaxUrl,
			type : "POST",
			dataType : 'json',
			success : function(data) {
				if(data.status == 'success') {
					var brands = data.items.topEntitySRO.allEntities;
					html = '<option value="0">Please select Brand: </option>';
					for ( var i = 0; i < brands.length; i++) {
						html += "<option value='" + brands[i].id + "'>" + brands[i].name
						+ "</option>";
					}
					$('#view-sw-brand').html(html);
					var subcatName = $('#subcat-search').val();
					var tableContent = data.items.topEntitySRO.topMatchingEntityList;
					populateSubcatWidgetTable(subcatName, tableContent);
				} else {
					addError("Failed to load sub categories for Brand.");
				}
			}
		});
}

function populateSubcatWidgetTable(subcatName, tableContent) {
	$('#sw-topBrandsTable').dataTable().fnClearTable();
	
	if (tableContent != null && tableContent.length > 0) {
		for ( var i = 0; i < (tableContent.length); i++) {
			$('#sw-topBrandsTable')
				.dataTable()
				.fnAddData(
					[	(i + 1),
					 	subcatName,
						tableContent[i].name,
						tableContent[i].properties.priority
					]);
		}
	}
}


$("#update-subcat-priority-button").click(function() {
	var subcatId = selectedSubcatId;
	var brandId = $('#view-sw-brand option:selected').attr('value');
	var priority = parseInt($('#subcatPriorityId').val());

	if (subcatId == 'undefined' || subcatId == "0") {
		addError("Please select a valid subcategory");
		return false;
	}
	if (brandId == "0") {
		addError("Please select a valid brand");
		return false;
	}
	if( priority == null || priority == "" || isNaN(priority)) {
		addError("Please add priority");
		return false;
	}
	updateSubcatWidgetPriority(subcatId,brandId, priority);	
});

function updateSubcatWidgetPriority(subcatId, brandId, priority) {
	var entityName = $('#subcat-search').val();
	var type = 'LEAF_CATEGORY';
	var depType = 'BRAND';
	var ajaxUrl = "/admin/rbf/update?entityId=" + subcatId + "&entityName=" + escape(entityName) + "&matchingEntityId=" + brandId + "&priority=" + priority 
						+ "&type=" + type + "&depType=" + depType;
	$.ajax({
			url : ajaxUrl,
			type : "POST",
			dataType : 'json',
			success : function(data) {
				if(data.status == 'success') {
					var subcatName = $('#subcat-search').val();
					var tableContent = data.items.topEntitySRO.topMatchingEntityList;
					populateSubcatWidgetTable(subcatName, tableContent);
					
					addSuccessMessage(data.message);
				} else {
					addError(data.message);
				}
			}
		});
}

$('#parentcat-search').typeahead([
                  {
                	    valueKey: 'displayName',
                	    local: allNonLeafLabels,
                	    template: [
                	   	        '<p class="name">{{displayName}} - ({{url}})</p>',
                	   	].join(''),
                	   	highlight: true,
                	   	limit: typeaheadLimit,
                	    engine: Hogan
                  }
                ]);

$('#parentcat-search').on('typeahead:autocompleted', function (object, datum) {
 	viewAllByParentCatId(datum);
});

 $('#parentcat-search').on('typeahead:selected', function (object, datum) {
	 viewAllByParentCatId(datum);
 });
 
function viewAllByParentCatId(datum) {
		selectedCatId = datum.url;
		var type = 'NON_LEAF_CATEGORY';
		var entityName = datum.displayName;
		if (entityName == '') {
			addError('Please Select a valid category:');
			return false;
		}
		var ajaxUrl = "/admin/rbf/getTop?entityId=" + selectedCatId + "&type=" + type + "&entityName=" + escape(entityName);
		$.ajax({
				url : ajaxUrl,
				type : "POST",
				dataType : 'json',
				success : function(data) {
					if(data.status == 'success') {					
						var allEntities = data.items.topEntitySRO.allEntities;
						var brandHtml = '<option value="0">Please select Brand : </option>';
						var subcatHtml = '<option value="0">Please select SubCategory : </option>';
						for ( var i = 0; i < allEntities.length; i++) {
							if(allEntities[i].type == 'brand' || allEntities[i].type == 'BRAND') {
								brandHtml += "<option value='" + allEntities[i].id + "'>" + allEntities[i].name
									+ "</option>";
							} else {
								subcatHtml += "<option value='" + allEntities[i].id + "'>" + allEntities[i].name
									+ "</option>";	
							}
						}
						$('#view-pw-brand').html(brandHtml);
						$('#view-pw-subcat').html(subcatHtml);
						
						var parentCatName = $('#parentcat-search').val();
						var tableContent = data.items.topEntitySRO.topMatchingEntityList;
						populateParentWidgetTable(parentCatName, tableContent);
					} else {
						addError("Failed to load sub categories and Brands.");
					}
				}
			});
 }

 
function populateParentWidgetTable(parentCatName, tableContent) {
		$('#pw-topTable').dataTable().fnClearTable();
		
		if (tableContent != null && tableContent.length > 0) {
			for ( var i = 0; i < (tableContent.length); i++) {
				$('#pw-topTable')
					.dataTable()
					.fnAddData(
						[	(i + 1),
						 	parentCatName,
							tableContent[i].name,
							tableContent[i].type,
							tableContent[i].properties.priority
						]);
			}
		}	 
 }

 $("#update-parentBrand-priority-button").click(function() {
 	var parentcatId = selectedCatId;
 	
 	var brandId = $('#view-pw-brand option:selected').attr('value');
 	var priority = $('#parentBrandPriorityId').val();

 	if (parentcatId == "0") {
 		addError("Please select a valid category");
 		return false;
 	}
 	if (brandId == "0") {
 		addError("Please select a valid brand");
 		return false;
 	}
 	if( priority == null || priority == "") {
 		addError("Please add priority");
 		return false;
 	}
 	updateParentWidgetPriority(parentcatId,brandId, priority, 'BRAND');	
 });

 $("#update-parentSubcat-priority-button").click(function() {
	var parentcatId = selectedCatId;
 	var id = $('#view-pw-subcat option:selected').attr('value');
 	var priority = $('#parentSubcatPriorityId').val();

 	if (parentcatId == "0") {
 		addError("Please select a valid category");
 		return false;
 	}
 	if (id == "0") {
 		addError("Please select a valid subcategory");
 		return false;
 	}
 	if( priority == null || priority == "") {
 		addError("Please add priority");
 		return false;
 	}
 	updateParentWidgetPriority(parentcatId,id, priority, 'LEAF_CATEGORY');	
 });

 
 function updateParentWidgetPriority(parentcatId, id, priority, depType) {
 	var entityName = $('#parentcat-search').val();
 	var type = 'NON_LEAF_CATEGORY';
 	var ajaxUrl = "/admin/rbf/update?entityId=" + parentcatId + "&entityName=" + escape(entityName) + "&matchingEntityId=" + id + "&priority=" + priority 
 					+ "&type=" + type + "&depType=" + depType;
 	$.ajax({
 			url : ajaxUrl,
 			type : "POST",
 			dataType : 'json',
 			success : function(data) {
 				if(data.status == 'success') {
 					var name = $('#parentcat-search').val();
 					var tableContent = data.items.topEntitySRO.topMatchingEntityList;
 					populateParentWidgetTable(name, tableContent);
 					
 					addSuccessMessage(data.message);
 				} else {
 					addError(data.message);
 				}
 			}
 		});
 }
